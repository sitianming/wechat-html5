// 获取openid
var oauth = function(){

    var pub = {};
    var rdurl = "";
    var scope = "";

    pub["openid"] = "";

    pub["init"] = function(param){
        rdurl = "http://lpwxpanel.evenhidata.com/api/oauth/openid/2";
        scope = "snsapi_base";
    }

    var GetQueryString = function(name)
    {
        var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if(r!=null){
            return unescape(r[2]);
        }
        return null;
    }

    pub["run"] = function(){
        var openid = getCookie("jsopenid");
//        var openid = null;
        if(!openid){
            openid = GetQueryString("openid");
            if(openid && openid.length > 18){
                setCookie("jsopenid",openid,"d30");
                var track = /trackingid=[\w]+/.exec(location.href);
                if(track){
                    track = track[0];
                }else{
                    track = "trackingid=notrack";
                }
                var url = location.href.split("?")[0] + "?" + track;
                setTimeout(function(){
                    location.href = url;
                },150);
                pub["openid"] = openid;
            }else{
                delCookie("jsopenid");
                go_wx_get_openid();
            }
        }else{
            pub["openid"] = openid;
        }

    };

    var go_wx_get_openid = function(){
        var state = base62(window.location.href);
        var wxurl = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx424588dbc3791d98&redirect_uri="
        + rdurl
        + "&response_type=code&scope="
        + scope
        + "&state="
        + state
        + "#wechat_redirect";
        window.location.href = wxurl;
    }


    var base62 = function (url){
        var base62str='0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
        var len=url.length;
        var i=0;
        var tmpArr=[];
        while(i<len){
            var val=url.substr(i,1);
            var ascii=val.charCodeAt();
            var ejz=parseInt(ascii).toString(2);
            for(var j=0;j<=(8-ejz.length);j++){
                ejz='0'+ejz;
            }
            tmpArr.push(ejz.substr(0,4));
            tmpArr.push(ejz.substr(4,4));
            ++i;
        }
        var t=0;
        var result='';
        var len=tmpArr.length;
        for(var x=0;x<len;x++){
            var temp=(parseInt(tmpArr[x],2))*4+t%2;
            var base=base62str.substr(temp,1);
            result=result+base;
            ++t;
        }
        return result;
    };

    function getCookie(name)
    {
        var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");
        if(arr=document.cookie.match(reg)){
            return unescape(arr[2]);
        } else{
            return null;
        }
    }

    function delCookie(name)
    {
        var exp = new Date();
        exp.setTime(exp.getTime() - 1);
        var cval=getCookie(name);
        if(cval!=null){
            document.cookie= name + "="+cval+";expires="+exp.toGMTString();
        }
    }

    function setCookie(name,value,time)
    {
        var strsec = getsec(time);
        var exp = new Date();
        exp.setTime(exp.getTime() + strsec*1);
        document.cookie = name + "="+ escape (value) + ";expires=" + exp.toGMTString();
    }

    //这是有设定过期时间的使用示例：
    //s20是代表20秒
    //h是指小时，如12小时则是：h12
    //d是天数，30天则：d30
    function getsec(str)
    {
        var str1=str.substring(1,str.length)*1;
        var str2=str.substring(0,1);
        if (str2=="s")
        {
            return str1*1000;
        }
        else if (str2=="h")
        {
            return str1*60*60*1000;
        }
        else if (str2=="d")
        {
            return str1*24*60*60*1000;
        }
    }

    return pub;
}();

var position = location.href;
if(!/p.evenhidata.com/.test(position)){
    // 本地
    // 这是斯天明的lp的openid，如果需要用自己的openid做测试，用手机访问这个项目的线上地址，然后复制链接
    oauth.openid = "olUr6jqtCMdpyeHvHiKB6w97j-bk";//"olUr6jo7IMLAfvksJ9J6FjEqyYXs"
}else{
    oauth.init({});
    oauth.run();
}

export default oauth.openid;
